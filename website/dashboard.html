<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script>
        const SHEET_API_KEY = "AIzaSyDiQ2Dc8GehVZwPJwu-XZX5ixQSzh5d3kQ";
        const SHEET_ID = "1KzuHUPiWefHFKA3f7bOoQbg8WVfGxDtfoNDm-linK_4";
        const SHEET_NAME = "Sheet1"; // Change if needed
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTjQV2e4kz1fbQREwK1D76JDxMMVhp7SLllC_ESb4eMr39iCy-omLz6yqyl6L5ROQk/exec"; // Replace with your actual Google Apps Script URL

        let userColumn = -1; // Store the user's column index

        async function loadUserData() {
            const username = localStorage.getItem("loggedInUser");
            if (!username) {
                window.location.href = "index.html";
                return;
            }

            if (userColumn !== -1 && data.values.length > 1) { 
    const userRealName = data.values[1][userColumn] || username; // Get value from row 2
    document.getElementById("welcomeMessage").innerText = `Welcome, ${userRealName}!`;
}


            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A:Z?key=${SHEET_API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    alert("Failed to fetch user data.");
                    return;
                }

                const userList = data.values[0]; // Row 1 (Usernames)
                userColumn = userList.indexOf(username); // Store the userâ€™s column index

                if (userColumn === -1) {
                    alert("User data not found.");
                    return;
                }

                const userData = data.values.map(row => row[userColumn] || ""); // Extract user's column
                displayUserData(userData);
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Error loading user data.");
            }
        }

        function displayUserData(userData) {
            const userDataDiv = document.getElementById("userData");
            userDataDiv.innerHTML = "<h3>Your Data:</h3>";
            userData.forEach((item, index) => {
                userDataDiv.innerHTML += `<p><strong>Row ${index + 1}:</strong> ${item}</p>`;
            });

            // Display the last entered value
            document.getElementById("displayData").textContent = userData[userData.length - 1] || "No data yet";
        }

        async function submitData(event) {
            event.preventDefault(); // Prevents form from reloading the page

            if (userColumn === -1) {
                alert("User column not found. Please reload the page.");
                return;
            }

            const userInput = document.getElementById("userInput").value.trim();
            if (!userInput) {
                alert("Please enter some data.");
                return;
            }

            const formData = new URLSearchParams();
            formData.append("username", localStorage.getItem("loggedInUser"));
            formData.append("column", userColumn);
            formData.append("data", userInput);

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: formData
                });

                // Since `no-cors` might be used, assume success if no error occurs
                document.getElementById("displayData").textContent = userInput;
                document.getElementById("userInput").value = ""; // Clear input field
                alert("Data submitted successfully!");

                // Reload user data after submission
                loadUserData();
            } catch (error) {
                console.error("Error updating data:", error);
                alert("Submission error.");
            }
        }

        function logout() {
            localStorage.removeItem("loggedInUser");
            window.location.replace("index.html"); // Redirect to login
        }

        window.onload = loadUserData;
    </script>
</head>
<body>

    <h2 id="welcomeMessage"></h2>
    <div id="userData"></div>

    <h3>Submit Data</h3>
    <p>Current Data: <span id="displayData">No data yet</span></p>

    <form onsubmit="submitData(event)">
        <input type="text" id="userInput" placeholder="Enter new data" required>
        <button type="submit">Update Data</button>
    </form>

    <button onclick="logout()">Logout</button>
</body>
</html>
